import streamlit as st
import pandas as pd
import io
from datetime import date

# --- 1. é é¢è¨­å®š ---
st.set_page_config(
    page_title="å»ºæ¡ˆé–‹å·¥è‡³æ”¾æ¨£SOPæ§ç®¡ç³»çµ±", 
    page_icon="ğŸ—ï¸", 
    layout="wide"
)

st.title("ğŸ—ï¸ å»ºæ¡ˆé–‹å·¥è‡³æ”¾æ¨£å‹˜é©— SOP æ§ç®¡ç³»çµ±")
st.markdown("### ä¾æ“šï¼šã€Œç”³è¾¦é–‹å·¥ã€è¨ˆåŠƒã€æ”¾æ¨£ç”¨æ¸…å†Š(çµ‚æ¥µç‰ˆ)ã€é‚è¼¯è¨­è¨ˆ")

# --- 2. æ ¸å¿ƒè³‡æ–™åº« (æ ¹æ“šæ‚¨çš„æª”æ¡ˆçµæ§‹å»ºç«‹) ---
# é€™è£¡å°‡æª”æ¡ˆä¸­çš„æª¢æŸ¥é»è½‰åŒ–ç‚ºæ•¸ä½è³‡æ–™
def load_sop_data():
    data = [
        # --- éšæ®µ 1: é–‹å·¥å‰ç½®ä½œæ¥­ (åŒ…å«å¤–éƒ¨å–®ä½) ---
        {
            "éšæ®µ": "1.é–‹å·¥å‰ç½®æº–å‚™",
            "é¡åˆ¥": "ç¾æ³èª¿æŸ¥",
            "ä½œæ¥­é …ç›®": "é„°æˆ¿ç¾æ³é‘‘å®šç”³è«‹",
            "æ‡‰å‚™æ–‡ä»¶": "é‘‘å®šç”³è«‹æ›¸ã€ç¹³è²»è­‰æ˜ã€é„°æˆ¿æ¸…å†Š",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "å»ºç¯‰å¸«å…¬æœƒ/åœŸæœ¨æŠ€å¸«å…¬æœƒ",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "éœ€æ–¼é–‹å·¥å‰å®Œæˆå ±å‘Š"
        },
        {
            "éšæ®µ": "1.é–‹å·¥å‰ç½®æº–å‚™",
            "é¡åˆ¥": "ç’°ä¿ç”³å ±",
            "ä½œæ¥­é …ç›®": "ç©ºæ°£æ±¡æŸ“é˜²åˆ¶è²»(é¦–æœŸ)ç¹³ç´",
            "æ‡‰å‚™æ–‡ä»¶": "ç©ºæ±™è²»ç”³å ±æ›¸ã€å·¥ç¨‹åˆç´„æ›¸ã€å»ºç…§å½±æœ¬",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "ç’°ä¿å±€",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "å–å¾—ç¹³æ¬¾å–®å¾Œ7æ—¥å…§ç¹³ç´"
        },
        {
            "éšæ®µ": "1.é–‹å·¥å‰ç½®æº–å‚™",
            "é¡åˆ¥": "ç’°ä¿ç”³å ±",
            "ä½œæ¥­é …ç›®": "ç‡Ÿå»ºå·¥ç¨‹å»¢æ£„ç‰©è™•ç†è¨ˆç•«æ›¸",
            "æ‡‰å‚™æ–‡ä»¶": "è¨ˆç•«æ›¸ã€æ¸…é‹åˆç´„ã€åœŸè³‡å ´åŒæ„æ›¸",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "ç’°ä¿å±€/å·¥å‹™å±€",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "éœ€æ ¸å®šå‡½æ‰å¯é–‹å·¥"
        },
        {
            "éšæ®µ": "1.é–‹å·¥å‰ç½®æº–å‚™",
            "é¡åˆ¥": "ç’°ä¿ç”³å ±",
            "ä½œæ¥­é …ç›®": "é€•æµå»¢æ°´å‰Šæ¸›è¨ˆç•«",
            "æ‡‰å‚™æ–‡ä»¶": "å‰Šæ¸›è¨ˆç•«æ›¸(å«æ²ˆæ²™æ± è¨ˆç®—)",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "ç’°ä¿å±€",
            "ç‹€æ…‹": False,
            "å‚™è¨»": ""
        },
        {
            "éšæ®µ": "1.é–‹å·¥å‰ç½®æº–å‚™",
            "é¡åˆ¥": "ç®¡ç·šæŸ¥è©¢",
            "ä½œæ¥­é …ç›®": "äº”å¤§ç®¡ç·šæŸ¥è©¢èˆ‡ç¢ºèª",
            "æ‡‰å‚™æ–‡ä»¶": "ç¾æ³åœ–ã€ç®¡ç·šæŸ¥è©¢å›å‡½",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "å°é›»ã€è‡ªä¾†æ°´ã€ç“¦æ–¯ã€é›»ä¿¡ã€æ±™æ°´",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "ç¢ºèªæœ‰ç„¡ç‰´è§¸"
        },
        
        # --- éšæ®µ 2: è¨ˆç•«æ›¸è£½ä½œèˆ‡æ ¸å®š ---
        {
            "éšæ®µ": "2.è¨ˆç•«æ›¸é€å¯©",
            "é¡åˆ¥": "æ–½å·¥è¨ˆç•«",
            "ä½œæ¥­é …ç›®": "æ–½å·¥è¨ˆç•«æ›¸ (å«é˜²ç½/äº¤é€šç¶­æŒ)",
            "æ‡‰å‚™æ–‡ä»¶": "æ–½å·¥è¨ˆç•«æ›¸ x Nä»½ã€ç°¡å ±æª”",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "å»ºç®¡è™•æ–½å·¥ç§‘/å¤–å¯©å§”å“¡",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "éœ€å¬é–‹èªªæ˜æœƒ"
        },
        {
            "éšæ®µ": "2.è¨ˆç•«æ›¸é€å¯©",
            "é¡åˆ¥": "å‹å®‰å“ç®¡",
            "ä½œæ¥­é …ç›®": "è·æ¥­å®‰å…¨è¡›ç”Ÿç®¡ç†è¨ˆç•«",
            "æ‡‰å‚™æ–‡ä»¶": "å‹å®‰è¨ˆç•«æ›¸ã€å®‰è¡›äººå“¡è­‰ç…§",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "å‹å‹•æª¢æŸ¥è™•",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "å±éšªæ€§å·¥ä½œå ´æ‰€éœ€å¦æ¡ˆå¯©æŸ¥"
        },
        {
            "éšæ®µ": "2.è¨ˆç•«æ›¸é€å¯©",
            "é¡åˆ¥": "å…¶ä»–",
            "ä½œæ¥­é …ç›®": "å‰©é¤˜åœŸçŸ³æ–¹è™•ç†è¨ˆç•«",
            "æ‡‰å‚™æ–‡ä»¶": "é‹é€æ†‘è­‰ã€åœŸæ–¹è¨ˆç®—æ›¸",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "å»ºç®¡è™•",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "å…©éšæ®µç”³å ±"
        },

        # --- éšæ®µ 3: é–‹å·¥ç”³å ± (æ­£å¼æ›è™Ÿ) ---
        {
            "éšæ®µ": "3.é–‹å·¥ç”³å ±(æ›è™Ÿ)",
            "é¡åˆ¥": "äººå“¡è­‰æ›¸",
            "ä½œæ¥­é …ç›®": "æ‰¿é€ äºº/å°ˆä»»å·¥ç¨‹äººå“¡/å·¥åœ°ä¸»ä»» è­‰æ›¸æª¢é™„",
            "æ‡‰å‚™æ–‡ä»¶": "å„é¡è­‰æ›¸å½±æœ¬ã€å…¬æœƒæœƒå“¡è­‰",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "å»ºç®¡è™•",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "éœ€ç¢ºèªè­‰ç…§æœ‰æ•ˆæœŸé™"
        },
        {
            "éšæ®µ": "3.é–‹å·¥ç”³å ±(æ›è™Ÿ)",
            "é¡åˆ¥": "ä¿éšª",
            "ä½œæ¥­é …ç›®": "ç‡Ÿé€ ç¶œåˆä¿éšªå–®",
            "æ‡‰å‚™æ–‡ä»¶": "ä¿éšªå–®æ­£æœ¬ã€æ”¶æ“š",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "ä¿éšªå…¬å¸/å»ºç®¡è™•å‚™æŸ¥",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "ä¿éšªæœŸé–“éœ€æ¶µè“‹å·¥æœŸ"
        },
        {
            "éšæ®µ": "3.é–‹å·¥ç”³å ±(æ›è™Ÿ)",
            "é¡åˆ¥": "åœ–èªª",
            "ä½œæ¥­é …ç›®": "é–‹å·¥åœ–èªªæª¢é™„",
            "æ‡‰å‚™æ–‡ä»¶": "å»ºç¯‰ç·šæŒ‡ç¤ºåœ–ã€çµæ§‹è©³åœ–ã€é…ç­‹åœ–",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "å»ºç®¡è™•",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "éœ€å»ºç¯‰å¸«ç°½è­‰"
        },

        # --- éšæ®µ 4: æ”¾æ¨£å‹˜é©—å‰æº–å‚™ ---
        {
            "éšæ®µ": "4.æ”¾æ¨£å‹˜é©—æº–å‚™",
            "é¡åˆ¥": "æ¸¬é‡",
            "ä½œæ¥­é …ç›®": "åŸºåœ°é‘‘ç•Œ",
            "æ‡‰å‚™æ–‡ä»¶": "åœŸåœ°è¤‡ä¸ˆç”³è«‹æ›¸",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "åœ°æ”¿äº‹å‹™æ‰€",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "ç¢ºèªç•Œå€é»"
        },
        {
            "éšæ®µ": "4.æ”¾æ¨£å‹˜é©—æº–å‚™",
            "é¡åˆ¥": "ç¾å ´",
            "ä½œæ¥­é …ç›®": "æ–½å·¥åœç±¬æ¶è¨­å®Œæˆ",
            "æ‡‰å‚™æ–‡ä»¶": "ç¶ ç¾åŒ–ç…§ç‰‡ã€è­¦ç¤ºç‡ˆ",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "å·¥åœ°ç¾å ´",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "éœ€ç¬¦åˆåœç±¬ç¾åŒ–è¦ç¯„"
        },
        {
            "éšæ®µ": "4.æ”¾æ¨£å‹˜é©—æº–å‚™",
            "é¡åˆ¥": "ç”³å ±",
            "ä½œæ¥­é …ç›®": "æ”¾æ¨£å‹˜é©—ç”³å ±",
            "æ‡‰å‚™æ–‡ä»¶": "å‹˜é©—ç”³è«‹æ›¸ã€æ¸¬é‡æˆæœå ±å‘Šã€ç¾å ´ç…§ç‰‡",
            "æ‰¿è¾¦å–®ä½/å°è±¡": "å»ºç®¡è™•/æŠ€å¸«å…¬æœƒ",
            "ç‹€æ…‹": False,
            "å‚™è¨»": "é€šå¸¸éœ€æå‰ç”³è«‹"
        }
    ]
    return pd.DataFrame(data)

# --- 3. åˆå§‹åŒ– Session State (è®“è³‡æ–™å¯ä»¥è¢«ç·¨è¼¯ä¸”æš«å­˜) ---
if "sop_df" not in st.session_state:
    st.session_state.sop_df = load_sop_data()

# --- 4. å´é‚Šæ¬„ï¼šå°ˆæ¡ˆè³‡è¨Šèˆ‡æ“ä½œ ---
with st.sidebar:
    st.header("ğŸ“ å°ˆæ¡ˆåŸºæœ¬è³‡æ–™")
    st.text_input("å°ˆæ¡ˆåç¨±", value="ç¯„ä¾‹å»ºæ¡ˆAå·¥å€")
    st.text_input("å»ºç…§è™Ÿç¢¼", value="113å»ºå­—ç¬¬00xxè™Ÿ")
    st.date_input("é è¨ˆé–‹å·¥æ—¥æœŸ", value=date.today())
    
    st.divider()
    st.info("ğŸ’¡ ç³»çµ±æ“ä½œèªªæ˜ï¼š\n1. ç›´æ¥åœ¨å³å´è¡¨æ ¼å‹¾é¸å®Œæˆã€‚\n2. å¯ä¿®æ”¹å‚™è¨»æ¬„ä½ã€‚\n3. ä¸‹æ–¹æŒ‰éˆ•å¯åŒ¯å‡º Excelã€‚")
    
    # é‡ç½®æŒ‰éˆ•
    if st.button("ğŸ”„ é‡ç½®æ‰€æœ‰é€²åº¦"):
        st.session_state.sop_df = load_sop_data()
        st.rerun()

# --- 5. ä¸»ç•«é¢ï¼šæ•¸æ“šå„€è¡¨æ¿ ---
df = st.session_state.sop_df

# è¨ˆç®—çµ±è¨ˆæ•¸æ“š
total = len(df)
done = len(df[df["ç‹€æ…‹"] == True])
percent = int((done / total) * 100)

col1, col2, col3, col4 = st.columns(4)
col1.metric("ç¸½ä½œæ¥­é …ç›®", f"{total} é …")
col2.metric("å·²å®Œæˆ", f"{done} é …")
col3.metric("å‰©é¤˜é …ç›®", f"{total - done} é …")
col4.progress(percent / 100, text=f"ç›®å‰é€²åº¦ï¼š{percent}%")

st.divider()

# --- 6. æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ†é¡é ç±¤é¡¯ç¤º (ç‚ºäº†ä¸è®“è¡¨æ ¼å¤ªé•·ï¼Œä¾éšæ®µåˆ†é ) ---
tabs = st.tabs(["å…¨éƒ¨æ¸…å–®", "1.é–‹å·¥å‰ç½®", "2.è¨ˆç•«æ›¸é€å¯©", "3.é–‹å·¥ç”³å ±", "4.æ”¾æ¨£å‹˜é©—"])

# å®šç¾©è¡¨æ ¼é¡¯ç¤ºè¨­å®š (Column Config)
column_cfg = {
    "éšæ®µ": st.column_config.TextColumn("ä½œæ¥­éšæ®µ", disabled=True, width="medium"),
    "é¡åˆ¥": st.column_config.TextColumn("é¡åˆ¥", disabled=True, width="small"),
    "ä½œæ¥­é …ç›®": st.column_config.TextColumn("ä½œæ¥­é …ç›®", disabled=True, width="large"),
    "æ‡‰å‚™æ–‡ä»¶": st.column_config.TextColumn("âš ï¸ æ‡‰å‚™æ–‡ä»¶ (é‡é»)", disabled=True, width="large"),
    "æ‰¿è¾¦å–®ä½/å°è±¡": st.column_config.TextColumn("æ‰¿è¾¦å–®ä½", width="medium"),
    "ç‹€æ…‹": st.column_config.CheckboxColumn("å®Œæˆ", width="small"),
    "å‚™è¨»": st.column_config.TextColumn("é€²åº¦/å‚™è¨» (å¯ç·¨è¼¯)", width="large"),
}

# é€™æ˜¯å…±ç”¨çš„ç·¨è¼¯å™¨å‡½æ•¸ï¼Œç”¨ä¾†éæ¿¾å’Œé¡¯ç¤ºè³‡æ–™
def show_editor(dataframe, key_suffix):
    edited = st.data_editor(
        dataframe,
        column_config=column_cfg,
        use_container_width=True,
        hide_index=True,
        num_rows="fixed", # å›ºå®šè¡Œæ•¸ï¼Œä¸éš¨æ„æ–°å¢é¿å…äº‚æ‰ï¼Œé™¤éæ‚¨æƒ³é–‹æ”¾
        key=f"editor_{key_suffix}"
    )
    return edited

with tabs[0]:
    st.caption("ğŸ“‹ ç¸½è¡¨æª¢è¦– (å¯åœ¨æ­¤ä¸€æ¬¡å‹¾é¸)")
    # ç·¨è¼¯æ•´å€‹ DataFrame
    new_df = show_editor(st.session_state.sop_df, "all")
    # å¦‚æœæœ‰è®Šå‹•ï¼Œæ›´æ–° session_state
    if not new_df.equals(st.session_state.sop_df):
        st.session_state.sop_df = new_df
        st.rerun()

# åˆ†é é¡¯ç¤ºé‚è¼¯ (é€™è£¡åªåšé¡¯ç¤ºèˆ‡é€£å‹•ï¼Œç·¨è¼¯å¾Œæœƒå›å¯«åˆ°ç¸½è¡¨)
# æ³¨æ„ï¼šStreamlit çš„ data_editor åœ¨éæ¿¾å¾Œçš„ dataframe ä¸Šç·¨è¼¯è¦å›å¯«æ¯”è¼ƒè¤‡é›œ
# ç‚ºäº†ç°¡åŒ–ä¸”ç©©å®šï¼Œå»ºè­°ä¸»è¦åœ¨ã€Œå…¨éƒ¨æ¸…å–®ã€æ“ä½œï¼Œæˆ–è€…ä½¿ç”¨ä¸‹é¢çš„éæ¿¾æª¢è¦–æ¨¡å¼

with tabs[1]:
    st.markdown("### 1. é–‹å·¥å‰ç½®æº–å‚™éšæ®µ")
    st.info("å«é„°æˆ¿é‘‘å®šã€ç’°ä¿ç©ºæ±™è²»ã€å»¢æ£„ç‰©è™•ç½®è¨ˆç•«ã€ç®¡ç·šæŸ¥è©¢ç­‰")
    # é€™è£¡æˆ‘å€‘åªé¡¯ç¤ºï¼Œè‹¥è¦ç·¨è¼¯å»ºè­°å›åˆ°ç¸½è¡¨ï¼Œæˆ–è€…æˆ‘å€‘å¯ä»¥åšç°¡å–®çš„éæ¿¾é¡¯ç¤º
    filter_df = st.session_state.sop_df[st.session_state.sop_df["éšæ®µ"] == "1.é–‹å·¥å‰ç½®æº–å‚™"]
    st.dataframe(filter_df, hide_index=True, use_container_width=True)

with tabs[2]:
    st.markdown("### 2. è¨ˆç•«æ›¸é€å¯©éšæ®µ")
    st.info("æ–½å·¥è¨ˆç•«æ›¸ã€å“è³ªç®¡ç†è¨ˆç•«ã€å‹å®‰è¨ˆç•«ç­‰")
    filter_df = st.session_state.sop_df[st.session_state.sop_df["éšæ®µ"] == "2.è¨ˆç•«æ›¸é€å¯©"]
    st.dataframe(filter_df, hide_index=True, use_container_width=True)

with tabs[3]:
    st.markdown("### 3. é–‹å·¥ç”³å ±éšæ®µ")
    st.info("æ­£å¼æ›è™Ÿç”¨æ–‡ä»¶ã€è­‰æ›¸ã€ä¿éšªå–®")
    filter_df = st.session_state.sop_df[st.session_state.sop_df["éšæ®µ"] == "3.é–‹å·¥ç”³å ±(æ›è™Ÿ)"]
    st.dataframe(filter_df, hide_index=True, use_container_width=True)

with tabs[4]:
    st.markdown("### 4. æ”¾æ¨£å‹˜é©—æº–å‚™")
    st.info("é‘‘ç•Œã€ç¾å ´è¨­æ–½è¨­ç½®ã€å‹˜é©—ç”³å ±")
    filter_df = st.session_state.sop_df[st.session_state.sop_df["éšæ®µ"] == "4.æ”¾æ¨£å‹˜é©—æº–å‚™"]
    st.dataframe(filter_df, hide_index=True, use_container_width=True)

# --- 7. ä¸‹è¼‰åŠŸèƒ½ (å­˜æª”ç”¨) ---
st.write("---")
st.subheader("ğŸ’¾ è³‡æ–™å­˜æª”")

# å°‡ç›®å‰çš„ DataFrame è½‰ç‚º Excel
buffer = io.BytesIO()
with pd.ExcelWriter(buffer, engine='xlsxwriter') as writer:
    st.session_state.sop_df.to_excel(writer, index=False, sheet_name='é–‹å·¥SOPæ¸…å–®')
    
    # è‡ªå‹•èª¿æ•´æ¬„å¯¬ (ç°¡å–®å„ªåŒ– Excel æ ¼å¼)
    worksheet = writer.sheets['é–‹å·¥SOPæ¸…å–®']
    worksheet.set_column('A:A', 15) # éšæ®µ
    worksheet.set_column('C:C', 25) # ä½œæ¥­é …ç›®
    worksheet.set_column('D:D', 40) # æ‡‰å‚™æ–‡ä»¶

st.download_button(
    label="ğŸ“¥ ä¸‹è¼‰ Excel é€²åº¦è¡¨ (å­˜æª”ç”¨)",
    data=buffer.getvalue(),
    file_name=f"é–‹å·¥SOPæ§ç®¡è¡¨_{date.today()}.xlsx",
    mime="application/vnd.ms-excel"
)